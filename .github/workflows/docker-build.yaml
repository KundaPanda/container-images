name: Build and push Docker images

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: build-matrix
        shell: bash
        run: |
          set -euo pipefail

          echo "### Collecting services from */service.json"

          services_json="[]"

          shopt -s nullglob
          for cfg in */service.json; do
            dir="$(dirname "$cfg")"      # e.g. "jellyfin"
            name="$(basename "$dir")"    # e.g. "jellyfin"

            svc="$(
              jq -c \
                --arg name "$name" \
                --arg dir "$dir" \
                '
                . as $cfg
                | {
                    name: $name,
                    dir: $dir,
                    context: ($cfg.context // $dir),
                    dockerfile: (
                      if ($cfg.dockerfile? // null) then
                        ($dir + "/" + $cfg.dockerfile)
                      else
                        ($dir + "/Dockerfile")
                      end
                    ),
                    platforms: ($cfg.platforms // ["linux/amd64"])
                  }
                ' "$cfg"
            )"

            services_json="$(
              jq -c --argjson svc "$svc" '. + [$svc]' <<<"$services_json"
            )"
          done
          shopt -u nullglob

          if [ "$services_json" = "[]" ]; then
            echo "No services (no */service.json) found."
            echo 'matrix={"include":[]}' >>"$GITHUB_OUTPUT"
            exit 0
          fi

          echo "All services:"
          echo "$services_json" | jq

          echo "### Determining base for diff"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
          else
            base="${{ github.event.before }}"
          fi

          echo "Base SHA: ${base:-<none>}"

          echo "### Computing changed top-level dirs"
          if [ -z "${base}" ]; then
            echo "No base SHA, treating all files as changed."
            changed_dirs="$(
              git ls-files | cut -d/ -f1 | sort -u
            )"
          else
            git fetch origin "${base}" --depth=1 || true
            changed_dirs="$(
              git diff --name-only "${base}"...HEAD \
                | cut -d/ -f1 \
                | sort -u \
                || true
            )"
          fi

          echo "Changed top-level dirs:"
          printf '%s\n' ${changed_dirs:-"(none)"}

          # Turn changed_dirs into a bash array
          changed_dirs_arr=()
          if [ -n "${changed_dirs:-}" ]; then
            # shellcheck disable=SC2207
            changed_dirs_arr=($(printf '%s\n' $changed_dirs))
          fi

          echo "Changed dirs array: ${changed_dirs_arr[*]:-"(empty)"}"

          echo "### Filtering services in bash based on changed dirs"
          selected_json="[]"

          # Iterate over each service object
          for svc in $(echo "$services_json" | jq -c '.[]'); do
            name="$(echo "$svc" | jq -r '.name')"

            matched=false
            if [ ${#changed_dirs_arr[@]} -gt 0 ]; then
              for d in "${changed_dirs_arr[@]}"; do
                if [ "$d" = "$name" ]; then
                  matched=true
                  break
                fi
              done
            fi

            if [ "$matched" = true ]; then
              echo "Service '$name' has changes."
              selected_json="$(
                jq -c --argjson svc "$svc" '. + [$svc]' <<<"$selected_json"
              )"
            fi
          done

          if [ "$selected_json" = "[]" ]; then
            echo "No service-specific changes; building all services."
            selected_json="$services_json"
          fi

          echo "Selected services:"
          echo "$selected_json" | jq

          matrix="{\"include\": $selected_json}"

          echo "Final matrix:"
          echo "$matrix" | jq

          echo "matrix=$matrix" >>"$GITHUB_OUTPUT"

  build-and-push:
    needs: generate-matrix
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-platform)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.name }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ matrix.platforms }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}